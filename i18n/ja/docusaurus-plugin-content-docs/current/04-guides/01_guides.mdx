---
id: guides
sidebar_position: 3
title: 開発ガイド
sidebar_label: guides
---

### 1. パーミッション管理
- SDK初期化前に必ずパーミッションを確認してください
- ユーザーフレンドリーなメッセージでパーミッション拒否を処理してください
- 必要なパーミッションに対する明確な根拠を提供してください
- 様々なAndroidバージョンでパーミッションフローをテストしてください

```kotlin
private fun showPermissionRationale() {
    Toast.makeText(
        this,
        "このアプリが正常に動作するためにはオーディオパーミッションが必要です。",
        Toast.LENGTH_LONG
    ).show()
}
```

### 2. リソース管理
- SDK使用完了時に`finish()`を呼び出してリソースをクリーンアップしてください
- パフォーマンス向上のためにアセットをキャッシュディレクトリにコピーしてください
- 適切なエラー処理でファイルI/O操作を処理してください
- `onDestroy()`でリソースをクリーンアップしてください

```kotlin
override fun onDestroy() {
    super.onDestroy()
    klleonOndeviceSdk.finish()
}
```

### 3. 状態監視
- ViewModelを使用してSDK状態変更を監視してください
- コルーチンスコープで状態更新を収集してください
- try-catchブロックでJSONレスポンスを安全にパーシングしてください
- UI変更のためにメインスレッドで状態更新を処理してください

### 4. エラー処理
- SDKメソッド呼び出しをtry-catchブロックでラップしてください
- デバッグのためにエラーを適切にログ出力してください
- 失敗した操作に対してユーザーフィードバックを提供してください
- SDKメソッド呼び出し前に入力を検証してください

```kotlin
fun safeOperation() {
    try {
        klleonOndeviceSdk.sendMessage(message)
    } catch (e: Exception) {
        Log.e("SDK", "操作失敗", e)
        showUserError("操作が失敗しました。再度お試しください。")
    }
}
```

### 5. UI統合
- Composeで`AndroidView`を使用して`KlleonSdkView`を統合してください
- SDKメソッド呼び出し前にビューが適切に初期化されていることを確認してください
- ビューライフサイクルを適切に処理してください
- 様々な画面サイズと向きでUIをテストしてください

## パフォーマンス最適化


### メモリ管理
```kotlin
// Composeでrememberを使用してオブジェクトの再作成を防止
val vpPath = remember { File(context.cacheDir, "loop_sample.mp4").absolutePath }
```

### スレッディング
```kotlin
// 状態監視のために適切なコルーチンスコープを使用
viewModelScope.launch {
    klleonOndeviceSdk.sdkState.collect { state ->
        // 状態更新の処理
    }
}
```

## トラブルシューティング

### 一般的な問題

#### 1. パーミッション拒否
**問題**: `RECORD_AUDIO`パーミッションが許可されない

**解決策**: 
- `AndroidManifest.xml`にパーミッションが宣言されているか確認
- パーミッション処理ロジックを確認
- 様々なAndroidバージョンでテスト

#### 2. SDK状態が更新されない
**問題**: 状態監視が動作しない

**解決策**:
- ViewModelで状態監視が適切に設定されているか確認
- コルーチンスコープがアクティブか確認
- 状態収集が開始されているか確認

#### 3. ビューが準備されていない
**問題**: `play()`呼び出し前に`KlleonSdkView`が初期化されていない

**解決策**:
- `AndroidView`ファクトリでビュー初期化を確認
- ビューが準備された時のみボタンを有効化
- SDKメソッド呼び出し前にnullチェックを追加

### デバッグのコツ

#### 状態モニタリング
```kotlin
// すべての状態変更をモニタリング
klleonOndeviceSdk.sdkState.collect { state ->
    Log.d("SDKState", "状態更新: $state")
    
    try {
        val jsonObject = JSONObject(state)
        Log.d("SDKState", "JSONパーシング成功: ${jsonObject.toString(2)}")
    } catch (e: Exception) {
        Log.e("SDKState", "JSONパーシングエラー", e)
    }
}
```

#### パフォーマンスモニタリング
```kotlin
// メモリ使用量のモニタリング
val runtime = Runtime.getRuntime()
val usedMemory = runtime.totalMemory() - runtime.freeMemory()
Log.d("Memory", "使用中メモリ: ${usedMemory / 1024 / 1024} MB")
```

## テスト戦略

### 単体テスト
```kotlin
@Test
fun `SDK状態変更テスト`() = runTest {
    // 予想状態変更の検証
}
```

### 統合テスト
```kotlin
@Test
fun `UI統合テスト`() {
    // UI要素とSDKの相互作用テスト
}
```

### パフォーマンステスト
- メモリリークテスト
- 長時間実行テスト
- 様々なデバイスでのパフォーマンステスト
```